<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doge 像素艺术生成器</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 20px;
        background-color: #f0f0f0;
      }
      h1 {
        color: #333;
      }
      #image-upload {
        margin: 20px 0;
      }
      #pixel-art {
        display: grid;
        gap: 0;
        margin: 20px auto;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .pixel {
        width: 5px;
        height: 5px;
      }
      #loading {
        display: none;
        margin-top: 20px;
        font-style: italic;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h1>上传 Doge 图片并生成像素艺术</h1>
    <input type="file" id="image-upload" accept="image/*" />
    <div id="loading">处理中，请稍候...</div>
    <div id="pixel-art"></div>

    <script>
      document
        .getElementById("image-upload")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (!file) return;

          const loadingElement = document.getElementById("loading");
          loadingElement.style.display = "block";

          const reader = new FileReader();
          reader.onload = function (e) {
            const img = new Image();
            img.src = e.target.result;

            img.onload = function () {
              const canvas = document.createElement("canvas");
              const ctx = canvas.getContext("2d");

              // 设置最大尺寸以优化性能
              const maxSize = 100;
              let width = img.width;
              let height = img.height;

              if (width > height && width > maxSize) {
                height *= maxSize / width;
                width = maxSize;
              } else if (height > maxSize) {
                width *= maxSize / height;
                height = maxSize;
              }

              width = Math.round(width);
              height = Math.round(height);

              canvas.width = width;
              canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);

              const imageData = ctx.getImageData(0, 0, width, height);
              const pixels = imageData.data;

              renderPixels(pixels, width, height);
              loadingElement.style.display = "none";
            };
          };
          reader.readAsDataURL(file);
        });

      function renderPixels(pixels, width, height) {
        const pixelArtContainer = document.getElementById("pixel-art");
        pixelArtContainer.innerHTML = "";

        pixelArtContainer.style.gridTemplateColumns = `repeat(${width}, 1fr)`;
        pixelArtContainer.style.width = `${width * 5}px`; // 5px 是每个像素的大小

        const fragment = document.createDocumentFragment();

        for (let y = 0; y < height; y++) {
          for (let x = 0; x < width; x++) {
            const index = (y * width + x) * 4;
            const r = pixels[index];
            const g = pixels[index + 1];
            const b = pixels[index + 2];
            const a = pixels[index + 3];

            const pixelDiv = document.createElement("div");
            pixelDiv.className = "pixel";
            pixelDiv.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${
              a / 255
            })`;
            fragment.appendChild(pixelDiv);
          }
        }

        pixelArtContainer.appendChild(fragment);
      }

      // 可选：上传图片到 CDN
      async function uploadToCDN(file) {
        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch("https://your-cdn-api/upload", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error("CDN upload failed");
          }

          const result = await response.json();
          console.log("Uploaded to CDN:", result.url);
          return result.url; // 返回 CDN 上的图片 URL
        } catch (error) {
          console.error("Error uploading to CDN:", error);
          return null;
        }
      }
    </script>
  </body>
</html>

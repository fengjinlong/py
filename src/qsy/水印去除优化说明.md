# 水印去除优化方案

## 问题分析
原始代码使用简单的高斯模糊 `(51, 51)` 参数，对于顽固水印效果不够理想，容易留下水印影子。

## 优化方案

### 1. 增强模糊方法 (enhanced_blur)
- 多次高斯模糊：`(151, 151)` → `(101, 101)`
- 中值模糊去除噪声：`(15, 15)`
- 双边滤波保持边缘：`(20, 80, 80)`

### 2. 超级增强方法 (super_enhanced) - 推荐
- 极强高斯模糊：`(201, 201)` → `(151, 151)` → `(101, 101)`
- 双重中值模糊：`(21, 21)` → `(15, 15)`
- 双边滤波平滑：`(30, 100, 100)`
- 形态学开运算去除噪点
- 最终高斯模糊确保完全平滑

### 3. 图像修复方法 (inpainting)
- 使用 OpenCV 的 `cv2.inpaint` 函数
- 适合复杂水印和文字水印

### 4. 形态学操作方法 (morphology)
- 使用形态学开闭运算
- 适合特定类型的水印

## 使用方法

### 方法一：使用优化版本
```bash
python qsy_sp_gemini_optimized.py
```

### 方法二：使用超级增强版本
```bash
python qsy_sp_gemini_advanced.py
```

### 方法三：修改原文件
将原文件中的 `remove_watermark` 函数替换为优化版本。

## 参数调整

### 修改水印区域
在 `WATERMARK_AREAS` 中调整坐标和大小：
```python
WATERMARK_AREAS = [
    {"x": 1200, "y": 660, "w": 50, "h": 36, "label": "WATERMARK1"},
    # 添加更多水印区域
    {"x": 500, "y": 300, "w": 150, "h": 40, "label": "WATERMARK2"},
]
```

### 选择去除方法
修改 `REMOVAL_METHOD` 变量：
```python
REMOVAL_METHOD = "super_enhanced"  # 推荐
```

### 开启调试模式
设置 `DRAW_WATERMARK_BOX = True` 来显示红色框，确认水印区域位置。

## 效果对比

| 方法 | 处理速度 | 效果质量 | 适用场景 |
|------|----------|----------|----------|
| gaussian_blur | 快 | 一般 | 简单水印 |
| enhanced_blur | 中等 | 好 | 一般水印 |
| super_enhanced | 慢 | 很好 | 顽固水印 |
| inpainting | 中等 | 好 | 复杂水印 |
| morphology | 快 | 中等 | 特定水印 |

## 建议

1. **首次使用**：建议使用 `super_enhanced` 方法
2. **调试阶段**：开启 `DRAW_WATERMARK_BOX = True` 确认水印位置
3. **批量处理**：确认效果满意后关闭调试模式
4. **性能优化**：如果效果满意但速度慢，可以尝试 `enhanced_blur`

## 注意事项

- 确保水印区域坐标准确
- 处理大视频文件时可能需要较长时间
- 建议先用小段视频测试效果
- 如果水印位置变化，需要重新调整坐标

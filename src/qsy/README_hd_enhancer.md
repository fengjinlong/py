# QSY 图片高清化工具

这是一个专门用于图片高清化处理的Python工具，结合了多种先进的图像处理算法，能够显著提升图片的清晰度和质量。

## 功能特点

### 1. 完全配置化管理
- **所有参数从配置文件读取** - 程序不包含任何硬编码的默认值
- **JSON配置文件** - 使用 `hd_config.json` 管理所有参数
- **命令行覆盖** - 支持通过命令行参数覆盖配置文件设置
- **配置验证** - 自动验证配置文件格式和完整性

### 2. 多种放大算法
- **双三次插值 (Bicubic)**: 经典的图像放大算法，平衡速度和质量
- **Lanczos插值**: 高质量的图像放大算法，细节保持更好
- **ESRGAN模拟**: 模拟ESRGAN深度学习算法的效果，通过锐化增强细节

### 3. 多种增强模式
- **基础增强**: 仅进行锐化处理
- **高级增强**: 锐化 + 对比度 + 色彩饱和度 + 亮度调整
- **超级增强**: 高级增强 + 双边滤波 + 去噪 + 拉普拉斯锐化

### 4. 灵活的处理模式
- **仅放大 (upscale)**: 只进行图像放大，不进行质量增强
- **仅增强 (enhance)**: 只进行质量增强，不改变图像尺寸
- **全部处理 (all)**: 先放大再增强，获得最佳效果

## 安装依赖

```bash
pip install opencv-python
pip install pillow
pip install numpy
```

## 参数指标详解

### 1. 保存质量等级划分 (save_quality)

| 质量范围 | 等级 | 适用场景 | 文件大小 | 视觉效果 | 推荐度 |
|---------|------|----------|----------|----------|--------|
| **90-100** | 最高质量 | 专业摄影、印刷、存档 | 最大 | 几乎无损 | ⭐⭐⭐ |
| **85-89** | 高质量 | 高质量展示、社交媒体 | 较大 | 极佳 | ⭐⭐⭐⭐ |
| **80-84** | 良好质量 | **推荐设置** | 适中 | 很好 | ⭐⭐⭐⭐⭐ |
| **70-79** | 中等质量 | 一般用途、网络传输 | 较小 | 良好 | ⭐⭐⭐ |
| **60-69** | 低质量 | 快速预览、缩略图 | 小 | 一般 | ⭐⭐ |
| **<60** | 很低质量 | 极低质量需求 | 很小 | 较差 | ⭐ |

#### 质量设置建议

- **80-85**: 最佳性价比，推荐用于大多数场景
- **90-95**: 专业用途，对质量要求极高的场景
- **75-80**: 文件大小优先，网络传输场景
- **避免100**: 文件过大，失去JPEG压缩优势

### 2. 放大倍数参数 (upscale_factor)

| 倍数 | 用途 | 处理时间 | 内存占用 | 效果 |
|------|------|----------|----------|------|
| **1** | 仅增强，不放大 | 最快 | 最小 | 保持原尺寸 |
| **2** | 标准放大 | 快 | 小 | 2倍分辨率 |
| **4** | 高倍放大 | 中等 | 中等 | 4倍分辨率 |
| **8** | 超高倍放大 | 慢 | 大 | 8倍分辨率 |

#### 放大倍数建议

- **1-2倍**: 日常使用，处理速度快
- **4倍**: 高质量需求，平衡效果和性能
- **8倍以上**: 专业用途，需要大量计算资源

### 3. 增强模式参数 (enhancement_mode)

| 模式 | 处理内容 | 处理时间 | 效果 | 适用场景 |
|------|----------|----------|------|----------|
| **basic** | 仅锐化 | 最快 | 基础 | 快速处理 |
| **advanced** | 锐化+对比度+色彩+亮度 | 中等 | 很好 | 推荐使用 |
| **super** | 高级+双边滤波+去噪+拉普拉斯 | 最慢 | 最佳 | 专业用途 |

### 4. 放大算法参数 (algorithms.upscale)

| 算法 | 速度 | 质量 | 细节保持 | 推荐场景 |
|------|------|------|----------|----------|
| **bicubic** | 最快 | 好 | 一般 | 批量处理 |
| **lanczos** | 中等 | 很好 | 好 | 平衡需求 |
| **esrgan_sim** | 最慢 | 最佳 | 最佳 | 高质量需求 |

### 5. 锐化参数详解 (enhancement_params)

#### 锐化半径 (sharpness_radius)
- **范围**: 1-5
- **推荐值**: 2-3
- **作用**: 控制锐化效果的扩散范围
- **影响**: 值越大，锐化效果越柔和

#### 锐化强度 (sharpness_percent)
- **范围**: 100-300
- **推荐值**: 120-180
- **作用**: 控制锐化效果的强度
- **影响**: 值越大，锐化效果越明显

#### 锐化阈值 (sharpness_threshold)
- **范围**: 0-10
- **推荐值**: 2-5
- **作用**: 控制锐化效果的敏感度
- **影响**: 值越大，只对边缘进行锐化

### 6. 色彩调整参数

#### 对比度因子 (contrast_factor)
- **范围**: 0.5-2.0
- **推荐值**: 1.1-1.3
- **作用**: 调整图像对比度
- **影响**: >1增强对比度，<1降低对比度

#### 色彩饱和度因子 (color_factor)
- **范围**: 0.5-2.0
- **推荐值**: 1.0-1.2
- **作用**: 调整图像色彩饱和度
- **影响**: >1增强饱和度，<1降低饱和度

#### 亮度因子 (brightness_factor)
- **范围**: 0.5-2.0
- **推荐值**: 0.9-1.1
- **作用**: 调整图像亮度
- **影响**: >1增加亮度，<1降低亮度

### 7. 高级处理参数

#### 双边滤波参数 (bilateral_filter)
- **d**: 滤波直径，推荐值 15-25
- **sigma_color**: 颜色空间标准差，推荐值 60-100
- **sigma_space**: 坐标空间标准差，推荐值 60-100

#### 去噪参数 (denoising_params)
- **h**: 去噪强度，推荐值 8-15
- **h_color**: 颜色去噪强度，推荐值 8-15
- **template_window_size**: 模板窗口大小，推荐值 7
- **search_window_size**: 搜索窗口大小，推荐值 21

#### 拉普拉斯锐化参数 (laplacian_sharpening)
- **alpha**: 锐化强度，推荐值 0.2-0.5

## 配置文件说明

**重要**: 程序完全依赖 `hd_config.json` 配置文件，不包含任何硬编码的默认值。

### 配置文件结构

```json
{
  "upscale_factor": 2,           // 放大倍数 (1-8)
  "enhancement_mode": "all",     // 处理模式: upscale/enhance/all
  "save_quality": 80,            // 保存质量 1-100 (推荐80-85)
  "algorithms": {
    "upscale": "esrgan_sim",     // 放大算法: bicubic/lanczos/esrgan_sim
    "enhance": "advanced"        // 增强算法: basic/advanced/super
  },
  "enhancement_params": {
    "sharpness_radius": 2,       // 锐化半径 (1-5)
    "sharpness_percent": 150,    // 锐化强度 (100-300)
    "sharpness_threshold": 3,    // 锐化阈值 (0-10)
    "contrast_factor": 1.2,      // 对比度因子 (0.5-2.0)
    "color_factor": 1.1,         // 色彩饱和度因子 (0.5-2.0)
    "brightness_factor": 1.05    // 亮度因子 (0.5-2.0)
  },
  "esrgan_params": {
    "sharpening_kernel": [[-1, -1, -1], [-1, 9, -1], [-1, -1, -1]],  // 锐化核
    "blend_ratio": 0.3           // 混合比例 (0.1-0.5)
  },
  "bilateral_filter": {
    "d": 20,                     // 双边滤波直径 (15-25)
    "sigma_color": 80,           // 颜色空间标准差 (60-100)
    "sigma_space": 80            // 坐标空间标准差 (60-100)
  },
  "denoising_params": {
    "h": 10,                     // 去噪强度 (8-15)
    "h_color": 10,               // 颜色去噪强度 (8-15)
    "template_window_size": 7,   // 模板窗口大小 (7)
    "search_window_size": 21     // 搜索窗口大小 (21)
  },
  "laplacian_sharpening": {
    "alpha": 0.3                 // 拉普拉斯锐化强度 (0.2-0.5)
  }
}
```

### 配置文件要求

1. **必须存在**: 程序启动时配置文件必须存在
2. **格式正确**: 必须是有效的JSON格式
3. **参数完整**: 必须包含所有必需的参数
4. **编码正确**: 必须使用UTF-8编码

## 使用方法

### 1. 基本使用

```bash
# 使用配置文件中的设置处理图片
python3 qsy_hd_enhancer.py

# 指定输入和输出文件夹
python3 qsy_hd_enhancer.py --input /path/to/input --output /path/to/output

# 使用自定义配置文件
python3 qsy_hd_enhancer.py --config /path/to/config.json
```

### 2. 命令行参数覆盖

```bash
# 覆盖配置文件中的放大倍数
python3 qsy_hd_enhancer.py --factor 4

# 覆盖配置文件中的处理模式
python3 qsy_hd_enhancer.py --mode enhance

# 覆盖配置文件中的保存质量
python3 qsy_hd_enhancer.py --quality 100

# 组合使用多个参数
python3 qsy_hd_enhancer.py --factor 4 --mode all --quality 100
```

### 3. 命令行参数说明

- `--input`: 输入文件夹路径 (默认: input_images/)
- `--output`: 输出文件夹路径 (默认: output_images/)
- `--config`: 配置文件路径 (默认: hd_config.json)
- `--factor`: 放大倍数 (覆盖配置文件中的设置)
- `--mode`: 处理模式 (upscale/enhance/all, 覆盖配置文件中的设置)
- `--quality`: 保存质量 1-100 (覆盖配置文件中的设置)

## 支持的图片格式

- PNG
- JPG/JPEG
- BMP
- TIFF
- WebP

## 使用示例

### 示例1: 使用默认配置
```bash
# 确保 hd_config.json 存在，然后运行
python3 qsy_hd_enhancer.py
```

### 示例2: 自定义配置
```bash
# 创建自定义配置文件
cp hd_config.json my_config.json
# 编辑 my_config.json 文件
# 使用自定义配置运行
python3 qsy_hd_enhancer.py --config my_config.json
```

### 示例3: 命令行覆盖
```bash
# 使用配置文件，但临时改变放大倍数
python3 qsy_hd_enhancer.py --factor 4
```

## 算法说明

### 放大算法对比

1. **双三次插值 (bicubic)**: 速度快，适合一般用途
2. **Lanczos插值 (lanczos)**: 质量好，适合需要保持细节的图片
3. **ESRGAN模拟 (esrgan_sim)**: 效果最佳，通过锐化增强细节，适合需要最高质量的场景

### 增强算法对比

1. **基础增强 (basic)**: 仅锐化，处理速度快
2. **高级增强 (advanced)**: 综合处理，平衡效果和速度
3. **超级增强 (super)**: 效果最佳，但处理时间较长

## 错误处理

### 配置文件错误
- **文件不存在**: 程序会报错并退出
- **格式错误**: 程序会报错并退出
- **参数缺失**: 程序会报错并退出

### 图片处理错误
- **读取失败**: 跳过该文件，继续处理其他文件
- **处理失败**: 记录错误日志，继续处理其他文件
- **保存失败**: 记录错误日志，继续处理其他文件

## 性能优化建议

1. **批量处理**: 将多张图片放在同一文件夹中批量处理
2. **算法选择**: 根据需求选择合适的算法组合
3. **质量设置**: 根据需要调整保存质量，平衡文件大小和效果
4. **配置文件**: 预先配置好所有参数，避免运行时修改

## 注意事项

1. **配置文件必需**: 程序启动前必须确保配置文件存在且格式正确
2. **处理大图片**: 处理大图片时可能需要较长时间
3. **超级增强模式**: 会显著增加处理时间
4. **备份原始文件**: 建议在处理前备份原始文件
5. **输出文件**: 输出文件会添加 "hd_" 前缀

## 故障排除

### 常见问题

1. **配置文件不存在**
   ```
   错误: 配置文件不存在: hd_config.json
   解决: 确保 hd_config.json 文件存在于程序目录中
   ```

2. **配置文件格式错误**
   ```
   错误: 配置文件格式错误: ...
   解决: 检查JSON格式是否正确，可以使用在线JSON验证工具
   ```

3. **参数缺失**
   ```
   错误: 配置文件加载失败: ...
   解决: 确保配置文件包含所有必需的参数
   ```

### 调试建议

1. 使用 `--help` 查看所有可用参数
2. 检查配置文件格式和内容
3. 查看详细的错误日志
4. 测试小批量图片处理

## 技术原理

- **图像放大**: 使用OpenCV的插值算法进行图像放大
- **质量增强**: 结合PIL和OpenCV的图像处理功能
- **细节增强**: 通过锐化滤波和边缘保持算法增强细节
- **色彩优化**: 通过对比度、饱和度和亮度调整优化视觉效果
- **配置管理**: 完全基于JSON配置文件的参数管理
